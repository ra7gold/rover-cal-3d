<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rover Calibration 3D Visualizer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e; 
            color: #eee;
            overflow: hidden;
        }
        #container { width: 100vw; height: 100vh; }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 10px;
            width: 280px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        h2 { 
            font-size: 14px; 
            margin-bottom: 8px; 
            color: #4ecdc4;
            border-bottom: 1px solid #4ecdc4;
            padding-bottom: 4px;
        }
        
        .control-group { margin-bottom: 12px; }
        
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        label { flex: 1; font-size: 11px; color: #aaa; }
        input[type="range"] { width: 90px; margin: 0 8px; cursor: pointer; }
        .value { width: 45px; text-align: right; font-family: monospace; font-size: 11px; color: #4ecdc4; }
        
        #results {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 10px;
            width: 200px;
            z-index: 100;
        }
        
        .result-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }
        .result-label { color: #aaa; }
        .result-value { font-family: monospace; font-weight: bold; }
        .pass { color: #4ecdc4; }
        .warn { color: #f9ca24; }
        .fail { color: #ff6b6b; }
        
        #legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 11px;
            z-index: 100;
        }
        .legend-item { display: flex; align-items: center; margin: 2px 0; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
        
        #instructions {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            color: #666;
            z-index: 100;
        }
        
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div id="controls">
        <h2>üìê Machine Orientation</h2>
        <div class="control-group">
            <div class="control-row">
                <label>Yaw (¬∞)</label>
                <input type="range" id="yaw" min="-45" max="45" value="0" step="1">
                <span class="value" id="yawVal">0</span>
            </div>
            <div class="control-row">
                <label>Pitch (¬∞)</label>
                <input type="range" id="pitch" min="-10" max="10" value="0" step="1">
                <span class="value" id="pitchVal">0</span>
            </div>
            <div class="control-row">
                <label>Roll (¬∞)</label>
                <input type="range" id="roll" min="-10" max="10" value="0" step="1">
                <span class="value" id="rollVal">0</span>
            </div>
        </div>
        
        <h2>üõ∞Ô∏è Rover Mount</h2>
        <div class="control-group">
            <div class="control-row">
                <label>Mount X (ft)</label>
                <input type="range" id="mountX" min="-4" max="-1" value="-3" step="1">
                <span class="value" id="mountXVal">-3</span>
            </div>
        </div>
        
        <h2>üì° Antenna Offsets</h2>
        <div class="control-group">
            <div class="control-row">
                <label>X fwd (ft)</label>
                <input type="range" id="antX" min="-2" max="4" value="1.6" step="0.1">
                <span class="value" id="antXVal">1.6</span>
            </div>
            <div class="control-row">
                <label>Y right (ft)</label>
                <input type="range" id="antY" min="0" max="8" value="5.4" step="0.1">
                <span class="value" id="antYVal">5.4</span>
            </div>
            <div class="control-row">
                <label>Z up (ft)</label>
                <input type="range" id="antZ" min="0" max="10" value="6.6" step="0.1">
                <span class="value" id="antZVal">6.6</span>
            </div>
        </div>
        
        <h2>üéØ Target Offset</h2>
        <div class="control-group">
            <div class="control-row">
                <label>N (ft)</label>
                <input type="range" id="targetN" min="-3" max="3" value="0" step="0.1">
                <span class="value" id="targetNVal">0</span>
            </div>
            <div class="control-row">
                <label>E (ft)</label>
                <input type="range" id="targetE" min="-3" max="3" value="0" step="0.1">
                <span class="value" id="targetEVal">0</span>
            </div>
        </div>
    </div>
    
    <div id="results">
        <h2>üìä QC Results</h2>
        <div class="result-row">
            <span class="result-label">N Error:</span>
            <span class="result-value pass" id="errN">0 mm</span>
        </div>
        <div class="result-row">
            <span class="result-label">E Error:</span>
            <span class="result-value pass" id="errE">0 mm</span>
        </div>
        <div class="result-row">
            <span class="result-label">Z Error:</span>
            <span class="result-value pass" id="errZ">0 mm</span>
        </div>
        <div class="result-row" style="margin-top:8px;padding-top:8px;border-top:1px solid #333;">
            <span class="result-label">Horiz:</span>
            <span class="result-value pass" id="errH">0 mm</span>
        </div>
        <div class="result-row">
            <span class="result-label">Status:</span>
            <span class="result-value pass" id="status">‚úÖ PASS</span>
        </div>
    </div>
    
    <div id="legend">
        <div class="legend-item"><div class="legend-color" style="background:#4ecdc4"></div>Work Point</div>
        <div class="legend-item"><div class="legend-color" style="background:#ff6b6b"></div>Machine Antenna</div>
        <div class="legend-item"><div class="legend-color" style="background:#f9ca24"></div>Rover</div>
        <div class="legend-item"><div class="legend-color" style="background:#a55eea"></div>Target</div>
        <div class="legend-item"><div class="legend-color" style="background:#26de81"></div>Computed WP</div>
    </div>
    
    <div id="instructions">üñ±Ô∏è Drag: rotate ‚Ä¢ Scroll: zoom ‚Ä¢ Shift+drag: pan</div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        
        // Camera
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(12, 10, 12);
        
        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('container').appendChild(renderer.domElement);
        
        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 2, 0);
        
        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);
        
        // Grid
        const grid = new THREE.GridHelper(20, 20, 0x444444, 0x333333);
        scene.add(grid);
        
        // Axes helper at origin
        const axesHelper = new THREE.AxesHelper(5);
        scene.add(axesHelper);
        
        // Materials
        const wpMat = new THREE.MeshStandardMaterial({ color: 0x4ecdc4, emissive: 0x4ecdc4, emissiveIntensity: 0.5 });
        const antMat = new THREE.MeshStandardMaterial({ color: 0xff6b6b, emissive: 0xff6b6b, emissiveIntensity: 0.5 });
        const roverMat = new THREE.MeshStandardMaterial({ color: 0xf9ca24, emissive: 0xf9ca24, emissiveIntensity: 0.5 });
        const targetMat = new THREE.MeshStandardMaterial({ color: 0xa55eea, emissive: 0xa55eea, emissiveIntensity: 0.5 });
        const computedMat = new THREE.MeshStandardMaterial({ color: 0x26de81, wireframe: true });
        const machineMat = new THREE.MeshStandardMaterial({ color: 0x555555, transparent: true, opacity: 0.6 });
        const poleMat = new THREE.MeshStandardMaterial({ color: 0x888888 });
        
        // Work Point
        const workPoint = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), wpMat);
        scene.add(workPoint);
        
        // Machine group
        const machineGroup = new THREE.Group();
        scene.add(machineGroup);
        
        // Machine body
        const machineBody = new THREE.Mesh(new THREE.BoxGeometry(5, 0.8, 2.5), machineMat);
        machineBody.position.y = 0.4;
        machineGroup.add(machineBody);
        
        // Machine axes (shows body frame)
        const machineAxes = new THREE.AxesHelper(2);
        machineGroup.add(machineAxes);
        
        // Machine antenna
        const antenna = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), antMat);
        machineGroup.add(antenna);
        
        // Antenna pole
        const antPole = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 1, 8), poleMat);
        machineGroup.add(antPole);
        
        // Rover
        const rover = new THREE.Mesh(new THREE.SphereGeometry(0.18, 16, 16), roverMat);
        machineGroup.add(rover);
        
        // Rover pole
        const roverPole = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 1.5, 8), poleMat);
        machineGroup.add(roverPole);
        
        // Target
        const target = new THREE.Mesh(new THREE.OctahedronGeometry(0.25), targetMat);
        scene.add(target);
        
        // Computed WP
        const computedWP = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), computedMat);
        scene.add(computedWP);
        
        // Error line
        const errorLineGeo = new THREE.BufferGeometry();
        const errorLine = new THREE.Line(errorLineGeo, new THREE.LineBasicMaterial({ color: 0xff6b6b, linewidth: 2 }));
        scene.add(errorLine);
        
        // Update function
        function update() {
            const yaw = parseFloat(document.getElementById('yaw').value);
            const pitch = parseFloat(document.getElementById('pitch').value);
            const roll = parseFloat(document.getElementById('roll').value);
            const mountX = parseFloat(document.getElementById('mountX').value);
            const antX = parseFloat(document.getElementById('antX').value);
            const antY = parseFloat(document.getElementById('antY').value);
            const antZ = parseFloat(document.getElementById('antZ').value);
            const targetN = parseFloat(document.getElementById('targetN').value);
            const targetE = parseFloat(document.getElementById('targetE').value);
            
            // Update display
            document.getElementById('yawVal').textContent = yaw;
            document.getElementById('pitchVal').textContent = pitch;
            document.getElementById('rollVal').textContent = roll;
            document.getElementById('mountXVal').textContent = mountX;
            document.getElementById('antXVal').textContent = antX.toFixed(1);
            document.getElementById('antYVal').textContent = antY.toFixed(1);
            document.getElementById('antZVal').textContent = antZ.toFixed(1);
            document.getElementById('targetNVal').textContent = targetN.toFixed(1);
            document.getElementById('targetEVal').textContent = targetE.toFixed(1);
            
            // Convert to radians
            const yawRad = yaw * Math.PI / 180;
            const pitchRad = pitch * Math.PI / 180;
            const rollRad = roll * Math.PI / 180;
            
            // Machine rotation (Three.js: Y=up, so yaw rotates around Y)
            machineGroup.rotation.set(pitchRad, -yawRad, rollRad, 'YXZ');
            
            // Antenna position in body frame -> Three.js coords
            // Body: X=forward, Y=right, Z=down
            // Three.js: X=forward(N), Y=up, Z=right(E)
            antenna.position.set(antX, antZ, antY);
            antPole.position.set(antX, antZ - 0.5, antY);
            
            // Rover position (on mount, behind WP)
            rover.position.set(mountX, 0.75, 0);
            roverPole.position.set(mountX, 0, 0);
            
            // Get world positions
            const antWorld = new THREE.Vector3();
            antenna.getWorldPosition(antWorld);
            
            const roverWorld = new THREE.Vector3();
            rover.getWorldPosition(roverWorld);
            
            // Target
            target.position.set(targetN, 0, targetE);
            
            // Compute WP from rover: WP = Rover - mountOffset in world
            // WP_N = Rover_N + mountX * cos(yaw)  [mountX is negative]
            // WP_E = Rover_E - mountX * sin(yaw)
            const compN = roverWorld.x + mountX * Math.cos(yawRad);
            const compE = roverWorld.z - mountX * Math.sin(yawRad);
            computedWP.position.set(compN, 0, compE);
            
            // Error (mm)
            const errN = (compN - targetN) * 304.8;
            const errE = (compE - targetE) * 304.8;
            const errZ = 0;
            const errH = Math.sqrt(errN*errN + errE*errE);
            
            // Update results
            const colorClass = (v, g, w) => Math.abs(v) <= g ? 'pass' : Math.abs(v) <= w ? 'warn' : 'fail';
            
            document.getElementById('errN').textContent = errN.toFixed(0) + ' mm';
            document.getElementById('errN').className = 'result-value ' + colorClass(errN, 10, 25);
            
            document.getElementById('errE').textContent = errE.toFixed(0) + ' mm';
            document.getElementById('errE').className = 'result-value ' + colorClass(errE, 10, 25);
            
            document.getElementById('errZ').textContent = errZ.toFixed(0) + ' mm';
            document.getElementById('errZ').className = 'result-value pass';
            
            document.getElementById('errH').textContent = errH.toFixed(0) + ' mm';
            document.getElementById('errH').className = 'result-value ' + colorClass(errH, 15, 30);
            
            const statusEl = document.getElementById('status');
            if (errH <= 15) {
                statusEl.textContent = '‚úÖ PASS';
                statusEl.className = 'result-value pass';
            } else if (errH <= 30) {
                statusEl.textContent = '‚ö†Ô∏è CHECK';
                statusEl.className = 'result-value warn';
            } else {
                statusEl.textContent = '‚ùå RECAL';
                statusEl.className = 'result-value fail';
            }
            
            // Error line
            const pts = [computedWP.position.clone(), target.position.clone()];
            pts[0].y = 0.1;
            pts[1].y = 0.1;
            errorLine.geometry.setFromPoints(pts);
        }
        
        // Event listeners
        document.querySelectorAll('input[type="range"]').forEach(el => {
            el.addEventListener('input', update);
        });
        
        // Animation
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        update();
        animate();
        
        console.log('ü¶û Rover Cal 3D loaded!');
    </script>
</body>
</html>
